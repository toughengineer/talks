# Demos

**taoJSON** ([taocpp/json](https://github.com/taocpp/json)) and **JSON for Modern C++** ([nlohman/json](https://github.com/nlohmann/json)) libraries are used in these demos.

## Unpacking array into function parameters
taoJSON: [godbolt.org/z/xGafx3xWY](https://godbolt.org/z/xGafx3xWY)

<details>
<summary>code (tap to show)</summary>
<div style="overflow-x: scroll;border: 1px solid lightgray;color: #000000;background-color: #fffffe;font-family: Consolas, 'Liberation Mono', Courier, monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">iostream</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string_view</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">type_traits</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">tao/json.hpp</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">namespace</span><span style="color: #000000;">&#160;std::literals::string_view_literals;</span></div><br><div><span style="color: #0000ff;">namespace</span><span style="color: #000000;">&#160;json&#160;=&#160;tao::json;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;F&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;">&#160;Overloaded&#160;:&#160;F...&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">using</span><span style="color: #000000;">&#160;F::</span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()...;</span></div><div><span style="color: #000000;">};</span></div><div><span style="color: #008000;">//&#160;deduction&#160;guide&#160;is&#160;needed&#160;until</span></div><div><span style="color: #008000;">//&#160;all&#160;compilers&#160;fully&#160;implement&#160;C++20</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;F&gt;</span></div><div><span style="color: #000000;">Overloaded(F...)-&gt;Overloaded&lt;F...&gt;;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;T&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;isConvertibleTo(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::value&#160;&amp;value)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::visit(</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;Overloaded{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;[](</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">)&#160;{&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_same_v&lt;T,&#160;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;;&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #008000;">//&#160;worksn't&#160;with&#160;GCC&#160;as&#160;of&#160;11.2&#160;and&#160;Clang&#160;12&#160;(fixed&#160;in&#160;13)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;[](std::floating_point&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">)&#160;{&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_floating_point_v&lt;T&gt;;&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;[](std::integral&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">)&#160;{&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_arithmetic_v&lt;T&gt;;&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #008000;">//&#160;worksn't&#160;at&#160;all&#160;with&#160;GCC&#160;as&#160;of&#160;11.2</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #008000;">//[]&lt;std::floating_point&#160;U&gt;(U)&#160;{&#160;return&#160;std::is_floating_point_v&lt;T&gt;;&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #008000;">//[]&lt;std::integral&#160;U&gt;(U)&#160;{&#160;return&#160;std::is_arithmetic_v&lt;T&gt;;&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;[](</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;&amp;v)&#160;{&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_convertible_v&lt;</span><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(v),&#160;T&gt;;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;value.variant());</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;T&gt;</span></div><div><span style="color: #000000;">std::string_view&#160;getTypeName()&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"boolean"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_integral_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"integer"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_floating_point_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"floating&#160;point&#160;number"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;std::string&gt;&#160;||&#160;std::is_same_v&lt;T,&#160;std::string_view&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"string"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;json::value::array_t&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"array"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;json::value&gt;&#160;||&#160;std::is_same_v&lt;T,&#160;json::value::object_t&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"object"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"unknown&#160;type"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;Variant&gt;</span></div><div><span style="color: #000000;">std::string_view&#160;getTypeName(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;Variant&#160;&amp;v)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::visit([](</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;&amp;&amp;v)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;std::decay_t&lt;</span><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(v)&gt;&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;},&#160;v);</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;">&#160;Name&#160;=&#160;std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;ExpectedType&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;reportInvalidArg(size_t&#160;i,&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::value&#160;&amp;value)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"*&#160;arg&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;(i&#160;+&#160;</span><span style="color: #098658;">1</span><span style="color: #000000;">)&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"&#160;has&#160;unexpected&#160;type:&#160;"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&lt;&lt;&#160;getTypeName(value.variant())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"&#160;(expected:&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;getTypeName&lt;ExpectedType&gt;()&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">")\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;T&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;validateArg(size_t&#160;i,&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::vector&lt;json::value&gt;&#160;&amp;args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(isConvertibleTo&lt;T&gt;(args[i]))</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;reportInvalidArg&lt;T&gt;(i,&#160;args[i]);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;Args&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;validateArgs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::vector&lt;json::value&gt;&#160;&amp;args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;size_t&#160;ArgCount&#160;=&#160;</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;argCountIsValid&#160;=&#160;args.size()&#160;==&#160;ArgCount;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!argCountIsValid)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"*&#160;invalid&#160;arg&#160;count:&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;args.size()&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"&#160;(expected:&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;ArgCount&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">")\n"</span><span style="color: #000000;">;</span></div><br><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;isValid&#160;=&#160;argCountIsValid;</span></div><div><span style="color: #000000;">&#160;&#160;size_t&#160;index&#160;=&#160;</span><span style="color: #098658;">0</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;((</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;isValid&#160;=&#160;index&#160;&lt;&#160;args.size()&#160;&amp;&amp;&#160;validateArg&lt;Args&gt;(index,&#160;args)&#160;&amp;&amp;&#160;isValid,&#160;++index</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;),&#160;...);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;isValid;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;T&gt;</span></div><div><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">)&#160;getAs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::value&#160;&amp;v)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;json::value&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;v;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;v.as&lt;T&gt;();</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;Args,&#160;size_t...&#160;I&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;applyImpl(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;(*handler)(Args...),&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::vector&lt;json::value&gt;&#160;&amp;args,&#160;std::index_sequence&lt;I...&gt;)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;handler(getAs&lt;std::decay_t&lt;Args&gt;&gt;(args[I])...);</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;Args&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;apply(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;(*handler)(Args...),&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::vector&lt;json::value&gt;&#160;&amp;args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;applyImpl(handler,&#160;args,&#160;std::make_index_sequence&lt;</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args)&gt;{});</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">struct</span><span style="color: #000000;">&#160;Handler&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;Args&gt;</span></div><div><span style="color: #000000;">&#160;&#160;Handler(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handler)(Args...))&#160;:&#160;erasedHandler{&#160;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*)()&gt;(handler)&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;handlerImpl{&#160;[](</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)(),&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::value&#160;*args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;handler&#160;=&#160;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*)(Args...)&gt;(erasedHandler);</span></div><br><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args)&#160;==&#160;</span><span style="color: #098658;">0</span><span style="color: #000000;">)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!args-&gt;is_array())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;'args'&#160;is&#160;not&#160;an&#160;array"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!args-&gt;get_array().empty())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"handler&#160;expects&#160;0&#160;arguments"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;handler();</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!args)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;does&#160;not&#160;contain&#160;arguments"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!args-&gt;is_array())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;'args'&#160;is&#160;not&#160;an&#160;array"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;&amp;argArray&#160;=&#160;args-&gt;get_array();</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!validateArgs&lt;std::decay_t&lt;Args&gt;...&gt;(argArray))</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;arguments&#160;are&#160;invalid"</span><span style="color: #000000;">&#160;};</span></div><br><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;apply(handler,&#160;argArray);</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;}&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;{}</span></div><br><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::value&#160;*args)&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;handlerImpl(erasedHandler,&#160;args);</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;}</span></div><br><div><span style="color: #0000ff;">private</span><span style="color: #000000;">:</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)()&#160;=&#160;</span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handlerImpl)(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)(),&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::value*)&#160;=&#160;</span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">};</span></div><br><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;foo()&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"got&#160;'foo'&#160;request\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;bar(std::string_view&#160;s)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"got&#160;'bar'&#160;request&#160;with\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #a31515;">"&#160;'"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;s&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;baz(</span><span style="color: #0000ff;">int</span><span style="color: #000000;">&#160;i,&#160;std::string_view&#160;s,&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::value&#160;&amp;p)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"got&#160;'baz'&#160;request&#160;with\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #a31515;">"&#160;'"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;i&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"',\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #a31515;">"&#160;'"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;s&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"',\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #a31515;">"&#160;and\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&lt;&lt;&#160;json::to_string(p)&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::tuple&lt;Name,&#160;Handler&gt;&#160;handlers[]&#160;=&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;{&#160;</span><span style="color: #a31515;">"foo"</span><span style="color: #000000;">,&#160;&amp;foo&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;{&#160;</span><span style="color: #a31515;">"bar"</span><span style="color: #000000;">,&#160;&amp;bar&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;{&#160;</span><span style="color: #a31515;">"baz"</span><span style="color: #000000;">,&#160;&amp;baz&#160;}</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;processRequest(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::string_view&#160;&amp;message)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;json&#160;=&#160;json::from_string(message);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!json.is_object())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;is&#160;not&#160;a&#160;valid&#160;JSON"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;*request&#160;=&#160;json.find(</span><span style="color: #a31515;">"request"</span><span style="color: #000000;">);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!request)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;does&#160;not&#160;contain&#160;name"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;*args&#160;=&#160;json.find(</span><span style="color: #a31515;">"args"</span><span style="color: #000000;">);</span></div><br><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;&amp;name&#160;=&#160;request-&gt;get_string();</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"*&#160;trying&#160;to&#160;process&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;name&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">for</span><span style="color: #000000;">&#160;(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;handler&#160;:&#160;handlers)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(std::get&lt;Name&gt;(handler)&#160;==&#160;name)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;std::get&lt;Handler&gt;(handler)(args);</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"*&#160;could&#160;not&#160;handle&#160;request&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;name&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">int</span><span style="color: #000000;">&#160;main()&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;request&#160;=&#160;</span><span style="color: #a31515;">R"({</span></div><div><span style="color: #a31515;">&#160;&#160;&#160;&#160;"request":"baz",</span></div><div><span style="color: #a31515;">&#160;&#160;&#160;&#160;"args":[1,&#160;"two",&#160;{&#160;"three":3&#160;}]</span></div><div><span style="color: #a31515;">})"</span><span style="color: #000000;">sv;</span></div><br><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">try</span><span style="color: #000000;">&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;processRequest(request);</span></div><div><span style="color: #000000;">&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">catch</span><span style="color: #000000;">&#160;(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::exception&#160;&amp;e)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"error:&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;e.what()&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;}</span></div><div><span style="color: #000000;">}</span></div></div>
</details>

JSON for Modern C++: [godbolt.org/z/3j9dooo4v](https://godbolt.org/z/3j9dooo4v)

<details>
<summary>code (tap to show)</summary>
<div style="overflow-x: scroll;border: 1px solid lightgray;color: #000000;background-color: #fffffe;font-family: Consolas, 'Liberation Mono', Courier, monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">iostream</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string_view</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">type_traits</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">#include</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">nlohmann/json.hpp</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">namespace</span><span style="color: #000000;">&#160;std::literals::string_view_literals;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;">&#160;nlohmann::json;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;T&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;isConvertibleTo(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json&#160;&amp;value)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">switch</span><span style="color: #000000;">&#160;(value.type())</span></div><div><span style="color: #000000;">&#160;&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::boolean:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_same_v&lt;T,&#160;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::string:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_convertible_v&lt;json::string_t,&#160;T&gt;;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::number_unsigned:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_convertible_v&lt;json::number_unsigned_t,&#160;T&gt;;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::number_integer:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_convertible_v&lt;json::number_integer_t,&#160;T&gt;;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::number_float:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_convertible_v&lt;json::number_float_t,&#160;T&gt;;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::object:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_same_v&lt;T,&#160;json&gt;&#160;||&#160;std::is_same_v&lt;T,&#160;json::object_t&gt;;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::array:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;std::is_same_v&lt;json::array_t,&#160;T&gt;;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">default</span><span style="color: #000000;">:&#160;</span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;T&gt;</span></div><div><span style="color: #000000;">std::string_view&#160;getTypeName()&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"boolean"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_integral_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"integer"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_floating_point_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"floating&#160;point&#160;number"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;std::string&gt;&#160;||&#160;std::is_same_v&lt;T,&#160;std::string_view&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"string"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;json::array_t&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"array"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;json&gt;&#160;||&#160;std::is_same_v&lt;T,&#160;json::object_t&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"object"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #a31515;">"unknown&#160;type"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #000000;">std::string_view&#160;getTypeName(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json&#160;&amp;value)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">switch</span><span style="color: #000000;">&#160;(value.type())</span></div><div><span style="color: #000000;">&#160;&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::boolean:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::string:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;json::string_t&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::number_unsigned:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;json::number_unsigned_t&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::number_integer:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;json::number_integer_t&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::number_float:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;json::number_float_t&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::object:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;json&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">case</span><span style="color: #000000;">&#160;json::value_t::array:&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;json::array_t&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">default</span><span style="color: #000000;">:&#160;</span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;getTypeName&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&gt;();&#160;</span><span style="color: #008000;">//&#160;for&#160;"unknown&#160;type"</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;">&#160;Name&#160;=&#160;std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;ExpectedType&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;reportInvalidArg(size_t&#160;i,&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json&#160;&amp;value)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"*&#160;arg&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;i&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"&#160;has&#160;unexpected&#160;type:&#160;"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&lt;&lt;&#160;getTypeName(value)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"&#160;(expected:&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;getTypeName&lt;ExpectedType&gt;()&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">")\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;T&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;validateArg(size_t&#160;i,&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::vector&lt;json&gt;&#160;&amp;args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(isConvertibleTo&lt;T&gt;(args[i]))</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;reportInvalidArg&lt;T&gt;(i,&#160;args[i]);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;Args&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;validateArgs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::vector&lt;json&gt;&#160;&amp;args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;size_t&#160;ArgCount&#160;=&#160;</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;argCountIsValid&#160;=&#160;args.size()&#160;==&#160;ArgCount;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!argCountIsValid)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"*&#160;invalid&#160;arg&#160;count:&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;args.size()&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"&#160;(expected:&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;ArgCount&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">")\n"</span><span style="color: #000000;">;</span></div><br><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&#160;isValid&#160;=&#160;argCountIsValid;</span></div><div><span style="color: #000000;">&#160;&#160;size_t&#160;index&#160;=&#160;</span><span style="color: #098658;">0</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;((</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;isValid&#160;=&#160;index&#160;&lt;&#160;args.size()&#160;&amp;&amp;&#160;validateArg&lt;Args&gt;(index,&#160;args)&#160;&amp;&amp;&#160;isValid,&#160;++index</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;),&#160;...);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;isValid;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">&#160;T&gt;</span></div><div><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">)&#160;getAs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json&#160;&amp;v)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(std::is_same_v&lt;T,&#160;json&gt;)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;v;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&#160;v.get&lt;T&gt;();</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;Args,&#160;size_t...&#160;I&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;applyImpl(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;(*handler)(Args...),&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::vector&lt;json&gt;&#160;&amp;args,&#160;std::index_sequence&lt;I...&gt;)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;handler(getAs&lt;std::decay_t&lt;Args&gt;&gt;(args[I])...);</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;Args&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;apply(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;(*handler)(Args...),&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::vector&lt;json&gt;&#160;&amp;args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;applyImpl(handler,&#160;args,&#160;std::make_index_sequence&lt;</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args)&gt;{});</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">struct</span><span style="color: #000000;">&#160;Handler&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">...&#160;Args&gt;</span></div><div><span style="color: #000000;">&#160;&#160;Handler(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handler)(Args...))&#160;:&#160;erasedHandler{&#160;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*)()&gt;(handler)&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;handlerImpl{&#160;[](</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)(),&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json&#160;*args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;handler&#160;=&#160;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*)(Args...)&gt;(erasedHandler);</span></div><br><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;">&#160;(</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args)&#160;==&#160;</span><span style="color: #098658;">0</span><span style="color: #000000;">)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(args)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!args-&gt;is_array())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;'args'&#160;is&#160;not&#160;an&#160;array"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!args-&gt;get_ref&lt;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::array_t&amp;&gt;().empty())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"handler&#160;expects&#160;0&#160;arguments"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;handler();</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">else</span><span style="color: #000000;">&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!args)</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;does&#160;not&#160;contain&#160;arguments"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!args-&gt;is_array())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;'args'&#160;is&#160;not&#160;an&#160;array"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;&amp;argArray&#160;=&#160;args-&gt;get_ref&lt;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::array_t&amp;&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!validateArgs&lt;std::decay_t&lt;Args&gt;...&gt;(argArray))</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;arguments&#160;are&#160;invalid"</span><span style="color: #000000;">&#160;};</span></div><br><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;apply(handler,&#160;argArray);</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;}&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;{}</span></div><br><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json&#160;*args)&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;handlerImpl(erasedHandler,&#160;args);</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;}</span></div><br><div><span style="color: #0000ff;">private</span><span style="color: #000000;">:</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)()&#160;=&#160;</span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handlerImpl)(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)(),&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json*)&#160;=&#160;</span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">};</span></div><br><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;foo()&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"got&#160;'foo'&#160;request\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;bar(std::string_view&#160;s)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"got&#160;'bar'&#160;request&#160;with\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #a31515;">"&#160;'"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;s&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;baz(</span><span style="color: #0000ff;">int</span><span style="color: #000000;">&#160;i,&#160;std::string_view&#160;s,&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json&#160;&amp;p)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"got&#160;'baz'&#160;request&#160;with\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #a31515;">"&#160;'"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;i&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"',\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #a31515;">"&#160;'"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;s&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"',\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #a31515;">"&#160;and\n"</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&lt;&lt;&#160;p.dump()&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::tuple&lt;Name,&#160;Handler&gt;&#160;handlers[]&#160;=&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;{&#160;</span><span style="color: #a31515;">"foo"</span><span style="color: #000000;">,&#160;&amp;foo&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;{&#160;</span><span style="color: #a31515;">"bar"</span><span style="color: #000000;">,&#160;&amp;bar&#160;},</span></div><div><span style="color: #000000;">&#160;&#160;{&#160;</span><span style="color: #a31515;">"baz"</span><span style="color: #000000;">,&#160;&amp;baz&#160;}</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;">&#160;processRequest(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::string_view&#160;&amp;message)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;json&#160;=&#160;json::parse(message);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(!json.is_object())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;is&#160;not&#160;a&#160;valid&#160;JSON"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;request&#160;=&#160;json.find(</span><span style="color: #a31515;">"request"</span><span style="color: #000000;">);</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(request&#160;==&#160;json.end())</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">throw</span><span style="color: #000000;">&#160;std::invalid_argument{&#160;</span><span style="color: #a31515;">"request&#160;does&#160;not&#160;contain&#160;name"</span><span style="color: #000000;">&#160;};</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;args&#160;=&#160;json.find(</span><span style="color: #a31515;">"args"</span><span style="color: #000000;">);</span></div><br><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;&amp;name&#160;=&#160;request-&gt;get_ref&lt;</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;json::string_t&amp;&gt;();</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"*&#160;trying&#160;to&#160;process&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;name&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">for</span><span style="color: #000000;">&#160;(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;handler&#160;:&#160;handlers)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">&#160;(std::get&lt;Name&gt;(handler)&#160;==&#160;name)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;std::get&lt;Handler&gt;(handler)(args&#160;==&#160;json.end()&#160;?&#160;</span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">&#160;:&#160;&amp;*args);</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;&#160;&#160;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"*&#160;could&#160;not&#160;handle&#160;request&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;name&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">int</span><span style="color: #000000;">&#160;main()&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">&#160;request&#160;=&#160;</span><span style="color: #a31515;">R"({</span></div><div><span style="color: #a31515;">&#160;&#160;&#160;&#160;"request":"baz",</span></div><div><span style="color: #a31515;">&#160;&#160;&#160;&#160;"args":[1,&#160;"two",&#160;{&#160;"three":3&#160;}]</span></div><div><span style="color: #a31515;">})"</span><span style="color: #000000;">sv;</span></div><br><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">try</span><span style="color: #000000;">&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;processRequest(request);</span></div><div><span style="color: #000000;">&#160;&#160;}</span></div><div><span style="color: #000000;">&#160;&#160;</span><span style="color: #0000ff;">catch</span><span style="color: #000000;">&#160;(</span><span style="color: #0000ff;">const</span><span style="color: #000000;">&#160;std::exception&#160;&amp;e)&#160;{</span></div><div><span style="color: #000000;">&#160;&#160;&#160;&#160;std::cout&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">"error:&#160;"</span><span style="color: #000000;">&#160;&lt;&lt;&#160;e.what()&#160;&lt;&lt;&#160;</span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160;&#160;}</span></div><div><span style="color: #000000;">}</span></div></div>
</details>

## Unpacking dictionary into named parameters
taoJSON: [godbolt.org/z/7Pz7jzeTa](https://godbolt.org/z/7Pz7jzeTa)

<details>
<summary>code (tap to show)</summary>
<div style="overflow-x: scroll;border: 1px solid lightgray;color: #000000;background-color: #fffffe;font-family: Consolas, 'Liberation Mono', Courier, monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">iostream</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string_view</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">optional</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">type_traits</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">tao/json.hpp</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> </span><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> std::literals::string_view_literals;</span></div><br><div><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> json = tao::json;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... F&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Overloaded : F... {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> F::</span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()...;</span></div><div><span style="color: #000000;">};</span></div><div><span style="color: #008000;">// deduction guide is needed until</span></div><div><span style="color: #008000;">// all compilers fully implement C++20</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... F&gt;</span></div><div><span style="color: #000000;">Overloaded(F...)-&gt;Overloaded&lt;F...&gt;;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isConvertibleTo(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;value) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::visit(</span></div><div><span style="color: #000000;">&#160; &#160; Overloaded{</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">) { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_same_v&lt;T, </span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #008000;">// worksn't with GCC as of 11.2 and Clang 12 (fixed in 13)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](std::floating_point </span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_floating_point_v&lt;T&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](std::integral </span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_arithmetic_v&lt;T&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #008000;">// worksn't at all with GCC as of 11.2</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #008000;">//[]&lt;std::floating_point U&gt;(U) { return std::is_floating_point_v&lt;T&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #008000;">//[]&lt;std::integral U&gt;(U) { return std::is_arithmetic_v&lt;T&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> &amp;v) { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;</span><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(v), T&gt;; }</span></div><div><span style="color: #000000;">&#160; &#160; },</span></div><div><span style="color: #000000;">&#160; &#160; value.variant());</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #000000;">std::string_view getTypeName() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, </span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"boolean"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_integral_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"integer"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_floating_point_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"floating point number"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, std::string&gt; || std::is_same_v&lt;T, std::string_view&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"string"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json::value::array_t&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"array"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json::value&gt; || std::is_same_v&lt;T, json::value::object_t&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"object"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"unknown type"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Variant&gt;</span></div><div><span style="color: #000000;">std::string_view getTypeName(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> Variant &amp;v) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::visit([](</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> &amp;&amp;v) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;std::decay_t&lt;</span><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(v)&gt;&gt;();</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }, v);</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> Name = std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;size_t N&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> StringLiteral {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> StringLiteral(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;">(&amp;str)[N]) </span><span style="color: #0000ff;">noexcept</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; std::copy_n(str, N, value);</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> value[N];</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral Name, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Param {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> ValueType = T;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> T &amp;value;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> std::string_view name() { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Name.value; }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral Name, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Param&lt;Name, std::optional&lt;T&gt;&gt; {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> ValueType = std::optional&lt;T&gt;;</span></div><div><span style="color: #000000;">&#160; std::optional&lt;T&gt; value;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> std::string_view name() { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Name.value; }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsParameter : std::false_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral N, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsParameter&lt;Param&lt;N, T&gt;&gt; : std::true_type {};</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> Name = std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsOptional : std::false_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsOptional&lt;std::optional&lt;T&gt;&gt; : std::true_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">inline</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isOptional = IsOptional&lt;T&gt;::value;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> ExpectedType&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> reportInvalidArg(std::string_view name, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;value) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* parameter '"</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">"' has unexpected type: "</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; getTypeName(value.variant())</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; </span><span style="color: #a31515;">" (expected: "</span><span style="color: #000000;"> &lt;&lt; getTypeName&lt;ExpectedType&gt;() &lt;&lt; </span><span style="color: #a31515;">")\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> validateArg(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> *value = request.find(Param::name());</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!value || value-&gt;is_null()) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* missing parameter '"</span><span style="color: #000000;"> &lt;&lt; Param::name() &lt;&lt; </span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType::value_type;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!isConvertibleTo&lt;T&gt;(*value)) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; reportInvalidArg&lt;T&gt;(Param::name(), *value);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!isConvertibleTo&lt;T&gt;(*value)) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; reportInvalidArg&lt;T&gt;(Param::name(), *value);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> validateArgs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isValid = </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; ((isValid = validateArg&lt;Args&gt;(request) &amp;&amp; isValid), ...);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> isValid;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) getAs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value *v) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;T&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> v &amp;&amp; !v-&gt;is_null() ? T{ getAs&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T::value_type&gt;(v) } : T{};</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json::value&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> *v;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> v-&gt;as&lt;T&gt;();</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> apply(</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> (*handler)(Args...), </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) {</span></div><div><span style="color: #000000;">&#160; handler(</span></div><div><span style="color: #000000;">&#160; &#160; { getAs&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Args::ValueType&gt;(request.find(Args::name())) }...</span></div><div><span style="color: #000000;">&#160; );</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> P&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> printParamDescription() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> P::ValueType;</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">" '"</span><span style="color: #000000;"> &lt;&lt; P::name() &lt;&lt; </span><span style="color: #a31515;">"': "</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;T&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; getTypeName&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T::value_type&gt;() &lt;&lt; </span><span style="color: #a31515;">" (optional)\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; getTypeName&lt;T&gt;() &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Handler {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">requires</span><span style="color: #000000;"> (IsParameter&lt;Args&gt;::value &amp;&amp; ...)</span></div><div><span style="color: #000000;">&#160; Handler(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handler)(Args...)) : erasedHandler{ </span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*)()&gt;(handler) },</span></div><div><span style="color: #000000;">&#160; &#160; handlerImpl{ [](</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)(), </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler = </span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*)(Args...)&gt;(erasedHandler);</span></div><br><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args) == </span><span style="color: #098658;">0</span><span style="color: #000000;">) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; handler();</span></div><div><span style="color: #000000;">&#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!validateArgs&lt;Args...&gt;(request))</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request arguments are invalid"</span><span style="color: #000000;"> };</span></div><br><div><span style="color: #000000;">&#160; &#160; &#160; &#160; apply(handler, request);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; } }</span></div><div><span style="color: #000000;">&#160; &#160; ,</span></div><div><span style="color: #000000;">&#160; &#160; printParamDescriptionsImpl{ [] {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args) == </span><span style="color: #098658;">0</span><span style="color: #000000;">)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">" (no parameters)\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; (printParamDescription&lt;Args&gt;(), ...);</span></div><div><span style="color: #000000;">&#160; } }</span></div><div><span style="color: #000000;">&#160; {}</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> </span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; handlerImpl(erasedHandler, request);</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> printParamDescriptions() </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; printParamDescriptionsImpl();</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #0000ff;">private</span><span style="color: #000000;">:</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)() = </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handlerImpl)(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)(), </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value&amp;) = </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*printParamDescriptionsImpl)() = </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">};</span></div><br><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> foo() {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'foo' request\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> bar(Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::string_view&gt; s) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'bar' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; s.value &lt;&lt; </span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> baz(Param&lt;</span><span style="color: #a31515;">"count"</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;">&gt; i, Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::string_view&gt; s, Param&lt;</span><span style="color: #a31515;">"payload"</span><span style="color: #000000;">, json::value&gt; p) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'baz' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; i.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; i.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; s.value &lt;&lt; </span><span style="color: #a31515;">"', and\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; p.name() &lt;&lt; </span><span style="color: #a31515;">"=\n"</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; json::to_string(p.value) &lt;&lt; </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> qux(Param&lt;</span><span style="color: #a31515;">"count"</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;">&gt; i, Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::optional&lt;std::string_view&gt;&gt; s, Param&lt;</span><span style="color: #a31515;">"payload"</span><span style="color: #000000;">, json::value&gt; p) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'qux' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; i.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; i.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (s.value) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">' '</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; *s.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">' '</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">" parameter is absent,\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">" and\n "</span><span style="color: #000000;"> &lt;&lt; p.name() &lt;&lt; </span><span style="color: #a31515;">"=\n"</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; json::to_string(p.value) &lt;&lt; </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::tuple&lt;Name, Handler&gt; handlers[] = {</span></div><div><span style="color: #000000;">&#160; { </span><span style="color: #a31515;">"foo"</span><span style="color: #000000;">, &amp;foo },</span></div><div><span style="color: #000000;">&#160; { </span><span style="color: #a31515;">"bar"</span><span style="color: #000000;">, &amp;bar },</span></div><div><span style="color: #000000;">&#160; { </span><span style="color: #a31515;">"baz"</span><span style="color: #000000;">, &amp;baz },</span></div><div><span style="color: #000000;">&#160; { </span><span style="color: #a31515;">"qux"</span><span style="color: #000000;">, &amp;qux }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> processRequest(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::string_view &amp;message) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> json = json::from_string(message);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!json.is_object())</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request is not a valid JSON"</span><span style="color: #000000;"> };</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> *request = json.find(</span><span style="color: #a31515;">"request"</span><span style="color: #000000;">);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!request)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request does not contain name"</span><span style="color: #000000;"> };</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> &amp;name = request-&gt;get_string();</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* trying to process "</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler : handlers) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (std::get&lt;Name&gt;(handler) == name) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; std::get&lt;Handler&gt;(handler)(json);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* could not handle request "</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> printDescriptions() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler : handlers) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;"> &lt;&lt; std::get&lt;Name&gt;(handler) &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; std::get&lt;Handler&gt;(handler).printParamDescriptions();</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">int</span><span style="color: #000000;"> main() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> request = </span><span style="color: #a31515;">R"({</span></div><div><span style="color: #a31515;">&#160; &#160; "request":"qux",</span></div><div><span style="color: #a31515;">&#160; &#160; "count":1,</span></div><div><span style="color: #a31515;">&#160; &#160; "id":"two",</span></div><div><span style="color: #a31515;">&#160; &#160; "payload":{ "three":3 }</span></div><div><span style="color: #a31515;">})"</span><span style="color: #000000;">sv;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; processRequest(request);</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::exception &amp;e) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"error: "</span><span style="color: #000000;"> &lt;&lt; e.what() &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"\n\nAPI description:\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; printDescriptions();</span></div><div><span style="color: #000000;">}</span></div></div>
</details>

JSON for Modern C++: [godbolt.org/z/nW1daos5n](https://godbolt.org/z/nW1daos5n)

<details>
<summary>code (tap to show)</summary>
<div style="overflow-x: scroll;border: 1px solid lightgray;color: #000000;background-color: #fffffe;font-family: Consolas, 'Liberation Mono', Courier, monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">iostream</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string_view</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">optional</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">type_traits</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">nlohmann/json.hpp</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> </span><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> std::literals::string_view_literals;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> nlohmann::json;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isConvertibleTo(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;value) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (value.type())</span></div><div><span style="color: #000000;">&#160; {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::boolean: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_same_v&lt;T, </span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::string: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;json::string_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_unsigned: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;json::number_unsigned_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_integer: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;json::number_integer_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_float: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;json::number_float_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::object: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_same_v&lt;T, json&gt; || std::is_same_v&lt;T, json::object_t&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::array: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_same_v&lt;json::array_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">: </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #000000;">std::string_view getTypeName() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, </span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"boolean"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_integral_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"integer"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_floating_point_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"floating point number"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, std::string&gt; || std::is_same_v&lt;T, std::string_view&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"string"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json::array_t&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"array"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json&gt; || std::is_same_v&lt;T, json::object_t&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"object"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"unknown type"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #000000;">std::string_view getTypeName(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;value) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (value.type())</span></div><div><span style="color: #000000;">&#160; {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::boolean: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::string: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::string_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_unsigned: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::number_unsigned_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_integer: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::number_integer_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_float: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::number_float_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::object: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::array: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::array_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">: </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&gt;(); </span><span style="color: #008000;">// for "unknown type"</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> Name = std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;size_t N&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> StringLiteral {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> StringLiteral(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;">(&amp;str)[N]) </span><span style="color: #0000ff;">noexcept</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; std::copy_n(str, N, value);</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> value[N];</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral Name, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Param {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> ValueType = T;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> T &amp;value;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> std::string_view name() { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Name.value; }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral Name, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Param&lt;Name, std::optional&lt;T&gt;&gt; {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> ValueType = std::optional&lt;T&gt;;</span></div><div><span style="color: #000000;">&#160; std::optional&lt;T&gt; value;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> std::string_view name() { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Name.value; }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsParameter : std::false_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral N, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsParameter&lt;Param&lt;N, T&gt;&gt; : std::true_type {};</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> Name = std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsOptional : std::false_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsOptional&lt;std::optional&lt;T&gt;&gt; : std::true_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">inline</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isOptional = IsOptional&lt;T&gt;::value;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> ExpectedType&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> reportInvalidArg(std::string_view name, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;value) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* parameter '"</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">"' has unexpected type: "</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; getTypeName(value)</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; </span><span style="color: #a31515;">" (expected: "</span><span style="color: #000000;"> &lt;&lt; getTypeName&lt;ExpectedType&gt;() &lt;&lt; </span><span style="color: #a31515;">")\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> validateArg(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> value = request.find(Param::name());</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (value == request.end() || value-&gt;is_null()) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* missing parameter '"</span><span style="color: #000000;"> &lt;&lt; Param::name() &lt;&lt; </span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType::value_type;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!isConvertibleTo&lt;T&gt;(*value)) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; reportInvalidArg&lt;T&gt;(Param::name(), *value);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!isConvertibleTo&lt;T&gt;(*value)) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; reportInvalidArg&lt;T&gt;(Param::name(), *value);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> validateArgs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isValid = </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; ((isValid = validateArg&lt;Args&gt;(request) &amp;&amp; isValid), ...);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> isValid;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) getAs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json *v) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;T&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> v &amp;&amp; !v-&gt;is_null() ? T{ getAs&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T::value_type&gt;(v) } : T{};</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> *v;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> v-&gt;get&lt;T&gt;();</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> apply(</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> (*handler)(Args...), </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) {</span></div><div><span style="color: #000000;">&#160; handler({ [&amp;request]()-&gt;</span><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> node = request.find(Args::name());</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getAs&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Args::ValueType&gt;(node == request.end() ? </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;"> : &amp;*node);</span></div><div><span style="color: #000000;">&#160; &#160; }() }...);</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> P&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> printParamDescription() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> P::ValueType;</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">" '"</span><span style="color: #000000;"> &lt;&lt; P::name() &lt;&lt; </span><span style="color: #a31515;">"': "</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;T&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; getTypeName&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T::value_type&gt;() &lt;&lt; </span><span style="color: #a31515;">" (optional)\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; getTypeName&lt;T&gt;() &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Handler {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">requires</span><span style="color: #000000;"> (IsParameter&lt;Args&gt;::value &amp;&amp; ...)</span></div><div><span style="color: #000000;">&#160; Handler(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handler)(Args...)) : erasedHandler{ </span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*)()&gt;(handler) },</span></div><div><span style="color: #000000;">&#160; &#160; handlerImpl{ [](</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)(), </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler = </span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*)(Args...)&gt;(erasedHandler);</span></div><br><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args) == </span><span style="color: #098658;">0</span><span style="color: #000000;">) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; handler();</span></div><div><span style="color: #000000;">&#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!validateArgs&lt;Args...&gt;(request))</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request arguments are invalid"</span><span style="color: #000000;"> };</span></div><br><div><span style="color: #000000;">&#160; &#160; &#160; &#160; apply(handler, request);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; } }</span></div><div><span style="color: #000000;">&#160; &#160; ,</span></div><div><span style="color: #000000;">&#160; &#160; printParamDescriptionsImpl{ [] {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args) == </span><span style="color: #098658;">0</span><span style="color: #000000;">)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">" (no parameters)\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; (printParamDescription&lt;Args&gt;(), ...);</span></div><div><span style="color: #000000;">&#160; } }</span></div><div><span style="color: #000000;">&#160; {}</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> </span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; handlerImpl(erasedHandler, request);</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> printParamDescriptions() </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; printParamDescriptionsImpl();</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #0000ff;">private</span><span style="color: #000000;">:</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)() = </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handlerImpl)(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*erasedHandler)(), </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json&amp;) = </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*printParamDescriptionsImpl)() = </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">};</span></div><br><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> foo() {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'foo' request\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> bar(Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::string_view&gt; s) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'bar' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; s.value &lt;&lt; </span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> baz(Param&lt;</span><span style="color: #a31515;">"count"</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;">&gt; i, Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::string_view&gt; s, Param&lt;</span><span style="color: #a31515;">"payload"</span><span style="color: #000000;">, json&gt; p) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'baz' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; i.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; i.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; s.value &lt;&lt; </span><span style="color: #a31515;">"', and\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; p.name() &lt;&lt; </span><span style="color: #a31515;">"=\n"</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; p.value.dump() &lt;&lt; </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> qux(Param&lt;</span><span style="color: #a31515;">"count"</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;">&gt; i, Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::optional&lt;std::string_view&gt;&gt; s, Param&lt;</span><span style="color: #a31515;">"payload"</span><span style="color: #000000;">, json&gt; p) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'qux' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; i.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; i.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (s.value) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">' '</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; *s.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">' '</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">" parameter is absent,\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">" and\n "</span><span style="color: #000000;"> &lt;&lt; p.name() &lt;&lt; </span><span style="color: #a31515;">"=\n"</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; p.value.dump() &lt;&lt; </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::tuple&lt;Name, Handler&gt; handlers[] = {</span></div><div><span style="color: #000000;">&#160; { </span><span style="color: #a31515;">"foo"</span><span style="color: #000000;">, &amp;foo },</span></div><div><span style="color: #000000;">&#160; { </span><span style="color: #a31515;">"bar"</span><span style="color: #000000;">, &amp;bar },</span></div><div><span style="color: #000000;">&#160; { </span><span style="color: #a31515;">"baz"</span><span style="color: #000000;">, &amp;baz },</span></div><div><span style="color: #000000;">&#160; { </span><span style="color: #a31515;">"qux"</span><span style="color: #000000;">, &amp;qux }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> processRequest(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::string_view &amp;message) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> json = json::parse(message);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!json.is_object())</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request is not a valid JSON"</span><span style="color: #000000;"> };</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> request = json.find(</span><span style="color: #a31515;">"request"</span><span style="color: #000000;">);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (request == json.end())</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request does not contain name"</span><span style="color: #000000;"> };</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> &amp;name = request-&gt;get_ref&lt;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::string_t&amp;&gt;();</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* trying to process "</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler : handlers) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (std::get&lt;Name&gt;(handler) == name) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; std::get&lt;Handler&gt;(handler)(json);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* could not handle request "</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> printDescriptions() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler : handlers) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;"> &lt;&lt; std::get&lt;Name&gt;(handler) &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; std::get&lt;Handler&gt;(handler).printParamDescriptions();</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">int</span><span style="color: #000000;"> main() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> request = </span><span style="color: #a31515;">R"({</span></div><div><span style="color: #a31515;">&#160; &#160; "request":"qux",</span></div><div><span style="color: #a31515;">&#160; &#160; "count":1,</span></div><div><span style="color: #a31515;">&#160; &#160; "id":"two",</span></div><div><span style="color: #a31515;">&#160; &#160; "payload":{ "three":3 }</span></div><div><span style="color: #a31515;">})"</span><span style="color: #000000;">sv;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; processRequest(request);</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::exception &amp;e) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"error: "</span><span style="color: #000000;"> &lt;&lt; e.what() &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"\n\nAPI description:\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; printDescriptions();</span></div><div><span style="color: #000000;">}</span></div></div>
</details>

## Member functions support
taoJSON: [godbolt.org/z/KPaMzcnvf](https://godbolt.org/z/KPaMzcnvf)

<details>
<summary>code (tap to show)</summary>
<div style="overflow-x: scroll;border: 1px solid lightgray;color: #000000;background-color: #fffffe;font-family: Consolas, 'Liberation Mono', Courier, monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">iostream</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string_view</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">optional</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">type_traits</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">tao/json.hpp</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> </span><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> std::literals::string_view_literals;</span></div><br><div><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> json = tao::json;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... F&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Overloaded : F... {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> F::</span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()...;</span></div><div><span style="color: #000000;">};</span></div><div><span style="color: #008000;">// deduction guide is needed until</span></div><div><span style="color: #008000;">// all compilers fully implement C++20</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... F&gt;</span></div><div><span style="color: #000000;">Overloaded(F...)-&gt;Overloaded&lt;F...&gt;;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isConvertibleTo(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;value) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::visit(</span></div><div><span style="color: #000000;">&#160; &#160; Overloaded{</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">) { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_same_v&lt;T, </span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #008000;">// worksn't with GCC as of 11.2 and Clang 12 (fixed in 13)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](std::floating_point </span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_floating_point_v&lt;T&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](std::integral </span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_arithmetic_v&lt;T&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #008000;">// worksn't at all with GCC as of 11.2</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #008000;">//[]&lt;std::floating_point U&gt;(U) { return std::is_floating_point_v&lt;T&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #008000;">//[]&lt;std::integral U&gt;(U) { return std::is_arithmetic_v&lt;T&gt;; },</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> &amp;v) { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;</span><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(v), T&gt;; }</span></div><div><span style="color: #000000;">&#160; &#160; },</span></div><div><span style="color: #000000;">&#160; &#160; value.variant());</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #000000;">std::string_view getTypeName() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, </span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"boolean"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_integral_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"integer"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_floating_point_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"floating point number"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, std::string&gt; || std::is_same_v&lt;T, std::string_view&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"string"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json::value::array_t&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"array"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json::value&gt; || std::is_same_v&lt;T, json::value::object_t&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"object"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"unknown type"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Variant&gt;</span></div><div><span style="color: #000000;">std::string_view getTypeName(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> Variant &amp;v) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::visit([](</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> &amp;&amp;v) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;std::decay_t&lt;</span><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(v)&gt;&gt;();</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }, v);</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> Name = std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;size_t N&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> StringLiteral {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> StringLiteral(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;">(&amp;str)[N]) </span><span style="color: #0000ff;">noexcept</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; std::copy_n(str, N, value);</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> value[N];</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral Name, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Param {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> ValueType = T;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> T &amp;value;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> std::string_view name() { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Name.value; }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral Name, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Param&lt;Name, std::optional&lt;T&gt;&gt; {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> ValueType = std::optional&lt;T&gt;;</span></div><div><span style="color: #000000;">&#160; std::optional&lt;T&gt; value;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> std::string_view name() { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Name.value; }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsParameter : std::false_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral N, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsParameter&lt;Param&lt;N, T&gt;&gt; : std::true_type {};</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> Name = std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsOptional : std::false_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsOptional&lt;std::optional&lt;T&gt;&gt; : std::true_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">inline</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isOptional = IsOptional&lt;T&gt;::value;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> ExpectedType&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> reportInvalidArg(std::string_view name, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;value) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* parameter '"</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">"' has unexpected type: "</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; getTypeName(value.variant())</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; </span><span style="color: #a31515;">" (expected: "</span><span style="color: #000000;"> &lt;&lt; getTypeName&lt;ExpectedType&gt;() &lt;&lt; </span><span style="color: #a31515;">")\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> validateArg(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> *value = request.find(Param::name());</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!value || value-&gt;is_null()) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* missing parameter '"</span><span style="color: #000000;"> &lt;&lt; Param::name() &lt;&lt; </span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType::value_type;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!isConvertibleTo&lt;T&gt;(*value)) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; reportInvalidArg&lt;T&gt;(Param::name(), *value);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!isConvertibleTo&lt;T&gt;(*value)) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; reportInvalidArg&lt;T&gt;(Param::name(), *value);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> validateArgs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isValid = </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; ((isValid = validateArg&lt;Args&gt;(request) &amp;&amp; isValid), ...);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> isValid;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) getAs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value *v) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;T&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> v &amp;&amp; !v-&gt;is_null() ? T{ getAs&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T::value_type&gt;(v) } : T{};</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json::value&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> *v;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> v-&gt;as&lt;T&gt;();</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Processor, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> apply(Processor &amp;processor, </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> (Processor::*handler)(Args...), </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) {</span></div><div><span style="color: #000000;">&#160; (processor.*handler)({ getAs&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Args::ValueType&gt;(request.find(Args::name())) }...);</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Processor&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Handler {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler&gt;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #008000;">//requires (IsParameter&lt;decltype(args)&gt;::value &amp;&amp; ...)</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> Handler makeHandler() {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> makeHandlerImpl&lt;handler&gt;(handler);</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> Handler() = </span><span style="color: #0000ff;">default</span><span style="color: #000000;">;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> </span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()(Processor &amp;processor, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; handlerImpl(processor, request);</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #0000ff;">private</span><span style="color: #000000;">:</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> Handler(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handlerImpl)(Processor&amp;, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value&amp;)) : handlerImpl{ handlerImpl }</span></div><div><span style="color: #000000;">&#160; {}</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> makeHandlerImpl(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(Processor::*)(Args...)) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Handler{</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](Processor &amp;processor, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value &amp;request) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args) == </span><span style="color: #098658;">0</span><span style="color: #000000;">) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; (processor.*handler)();</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!validateArgs&lt;Args...&gt;(request))</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request arguments are invalid"</span><span style="color: #000000;"> };</span></div><br><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; apply(processor, handler, request);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; };</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handlerImpl)(Processor&amp;, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::value&amp;) = </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">};</span></div><br><br><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Processor {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> foo() {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'foo' request\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> bar(Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::string_view&gt; s) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'bar' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; s.value &lt;&lt; </span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> baz(Param&lt;</span><span style="color: #a31515;">"count"</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;">&gt; i, Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::string_view&gt; s, Param&lt;</span><span style="color: #a31515;">"payload"</span><span style="color: #000000;">, json::value&gt; p) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'baz' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; i.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; i.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; s.value &lt;&lt; </span><span style="color: #a31515;">"', and\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; p.name() &lt;&lt; </span><span style="color: #a31515;">"=\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &lt;&lt; json::to_string(p.value) &lt;&lt; </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> qux(Param&lt;</span><span style="color: #a31515;">"count"</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;">&gt; i, Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::optional&lt;std::string_view&gt;&gt; s, Param&lt;</span><span style="color: #a31515;">"payload"</span><span style="color: #000000;">, json::value&gt; p) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'qux' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; i.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; i.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (s.value) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">' '</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; *s.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">' '</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">" parameter is absent,\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">" and\n "</span><span style="color: #000000;"> &lt;&lt; p.name() &lt;&lt; </span><span style="color: #a31515;">"=\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &lt;&lt; json::to_string(p.value) &lt;&lt; </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">};</span></div><br><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral name, </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler&gt;</span></div><div><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> h() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::tuple{ Name{ name.value }, Handler&lt;Processor&gt;::makeHandler&lt;handler&gt;() };</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> std::tuple&lt;Name, Handler&lt;Processor&gt;&gt; handlers[] = {</span></div><div><span style="color: #000000;">&#160; h&lt;</span><span style="color: #a31515;">"foo"</span><span style="color: #000000;">, &amp;Processor::foo&gt;(),</span></div><div><span style="color: #000000;">&#160; h&lt;</span><span style="color: #a31515;">"bar"</span><span style="color: #000000;">, &amp;Processor::bar&gt;(),</span></div><div><span style="color: #000000;">&#160; h&lt;</span><span style="color: #a31515;">"baz"</span><span style="color: #000000;">, &amp;Processor::baz&gt;(),</span></div><div><span style="color: #000000;">&#160; h&lt;</span><span style="color: #a31515;">"qux"</span><span style="color: #000000;">, &amp;Processor::qux&gt;()</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> processRequest(Processor &amp;processor, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::string_view &amp;message) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> json = json::from_string(message);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!json.is_object())</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request is not a valid JSON"</span><span style="color: #000000;"> };</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> *request = json.find(</span><span style="color: #a31515;">"request"</span><span style="color: #000000;">);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!request)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request does not contain name"</span><span style="color: #000000;"> };</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> &amp;name = request-&gt;get_string();</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* trying to process "</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler : handlers) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (std::get&lt;Name&gt;(handler) == name) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; std::get&lt;Handler&lt;Processor&gt;&gt;(handler)(processor, json);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* could not handle request "</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">int</span><span style="color: #000000;"> main() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> request = </span><span style="color: #a31515;">R"({</span></div><div><span style="color: #a31515;">&#160; &#160; "request":"qux",</span></div><div><span style="color: #a31515;">&#160; &#160; "count":1,</span></div><div><span style="color: #a31515;">&#160; &#160; "id":"two",</span></div><div><span style="color: #a31515;">&#160; &#160; "payload":{ "three":3 }</span></div><div><span style="color: #a31515;">})"</span><span style="color: #000000;">sv;</span></div><br><div><span style="color: #000000;">&#160; Processor processor{};</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; processRequest(processor, request);</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::exception &amp;e) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"error: "</span><span style="color: #000000;"> &lt;&lt; e.what() &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div></div>
</details>

JSON for Modern C++: [godbolt.org/z/G548Knbjj](https://godbolt.org/z/G548Knbjj)

<details>
<summary>code (tap to show)</summary>
<div style="overflow-x: scroll;border: 1px solid lightgray;color: #000000;background-color: #fffffe;font-family: Consolas, 'Liberation Mono', Courier, monospace, Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">iostream</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">string_view</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">optional</span><span style="color: #0000ff;">&gt;</span></div><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">type_traits</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">#include</span><span style="color: #000000;"> </span><span style="color: #0000ff;">&lt;</span><span style="color: #a31515;">nlohmann/json.hpp</span><span style="color: #0000ff;">&gt;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> </span><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> std::literals::string_view_literals;</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> nlohmann::json;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isConvertibleTo(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;value) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (value.type())</span></div><div><span style="color: #000000;">&#160; {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::boolean: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_same_v&lt;T, </span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::string: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;json::string_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_unsigned: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;json::number_unsigned_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_integer: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;json::number_integer_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_float: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_convertible_v&lt;json::number_float_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::object: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_same_v&lt;T, json&gt; || std::is_same_v&lt;T, json::object_t&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::array: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::is_same_v&lt;json::array_t, T&gt;;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">: </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #000000;">std::string_view getTypeName() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, </span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"boolean"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_integral_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"integer"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_floating_point_v&lt;T&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"floating point number"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, std::string&gt; || std::is_same_v&lt;T, std::string_view&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"string"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json::array_t&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"array"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json&gt; || std::is_same_v&lt;T, json::object_t&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"object"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #a31515;">"unknown type"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #000000;">std::string_view getTypeName(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;value) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (value.type())</span></div><div><span style="color: #000000;">&#160; {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::boolean: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;</span><span style="color: #0000ff;">bool</span><span style="color: #000000;">&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::string: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::string_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_unsigned: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::number_unsigned_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_integer: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::number_integer_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::number_float: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::number_float_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::object: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> json::value_t::array: </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;json::array_t&gt;();</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">default</span><span style="color: #000000;">: </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getTypeName&lt;</span><span style="color: #0000ff;">void</span><span style="color: #000000;">&gt;(); </span><span style="color: #008000;">// for "unknown type"</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> Name = std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;size_t N&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> StringLiteral {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> StringLiteral(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">char</span><span style="color: #000000;">(&amp;str)[N]) </span><span style="color: #0000ff;">noexcept</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; std::copy_n(str, N, value);</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> value[N];</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral Name, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Param {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> ValueType = T;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> T &amp;value;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> std::string_view name() { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Name.value; }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral Name, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Param&lt;Name, std::optional&lt;T&gt;&gt; {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> ValueType = std::optional&lt;T&gt;;</span></div><div><span style="color: #000000;">&#160; std::optional&lt;T&gt; value;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> std::string_view name() { </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Name.value; }</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsParameter : std::false_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral N, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsParameter&lt;Param&lt;N, T&gt;&gt; : std::true_type {};</span></div><br><div><span style="color: #0000ff;">using</span><span style="color: #000000;"> Name = std::string_view;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsOptional : std::false_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> IsOptional&lt;std::optional&lt;T&gt;&gt; : std::true_type {};</span></div><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">inline</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isOptional = IsOptional&lt;T&gt;::value;</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> ExpectedType&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> reportInvalidArg(std::string_view name, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;value) {</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* parameter '"</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">"' has unexpected type: "</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; getTypeName(value)</span></div><div><span style="color: #000000;">&#160; &#160; &lt;&lt; </span><span style="color: #a31515;">" (expected: "</span><span style="color: #000000;"> &lt;&lt; getTypeName&lt;ExpectedType&gt;() &lt;&lt; </span><span style="color: #a31515;">")\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> validateArg(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> value = request.find(Param::name());</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (value == request.end() || value-&gt;is_null()) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* missing parameter '"</span><span style="color: #000000;"> &lt;&lt; Param::name() &lt;&lt; </span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType::value_type;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!isConvertibleTo&lt;T&gt;(*value)) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; reportInvalidArg&lt;T&gt;(Param::name(), *value);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">using</span><span style="color: #000000;"> T = </span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Param::ValueType;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!isConvertibleTo&lt;T&gt;(*value)) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; reportInvalidArg&lt;T&gt;(Param::name(), *value);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #0000ff;">bool</span><span style="color: #000000;"> validateArgs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isValid = </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; ((isValid = validateArg&lt;Args&gt;(request) &amp;&amp; isValid), ...);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> isValid;</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T&gt;</span></div><div><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) getAs(</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json *v) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (isOptional&lt;T&gt;) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> v &amp;&amp; !v-&gt;is_null() ? T{ getAs&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> T::value_type&gt;(v) } : T{};</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (std::is_same_v&lt;T, json&gt;)</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> *v;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> v-&gt;get&lt;T&gt;();</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Processor, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> apply(Processor &amp;processor, </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> (Processor::*handler)(Args...), </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) {</span></div><div><span style="color: #000000;">&#160; (processor.*handler)({ [&amp;request]()-&gt;</span><span style="color: #0000ff;">decltype</span><span style="color: #000000;">(</span><span style="color: #0000ff;">auto</span><span style="color: #000000;">) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> node = request.find(Args::name());</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> getAs&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Args::ValueType&gt;(node == request.end() ? </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;"> : &amp;*node);</span></div><div><span style="color: #000000;">&#160; &#160; }() }...);</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">typename</span><span style="color: #000000;"> Processor&gt;</span></div><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Handler {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler&gt;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #008000;">//requires (IsParameter&lt;decltype(args)&gt;::value &amp;&amp; ...)</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> Handler makeHandler() {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> makeHandlerImpl&lt;handler&gt;(handler);</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> Handler() = </span><span style="color: #0000ff;">default</span><span style="color: #000000;">;</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> </span><span style="color: #0000ff;">operator</span><span style="color: #000000;">()(Processor &amp;processor, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; handlerImpl(processor, request);</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #0000ff;">private</span><span style="color: #000000;">:</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> Handler(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handlerImpl)(Processor&amp;, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json&amp;)) : handlerImpl{ handlerImpl }</span></div><div><span style="color: #000000;">&#160; {}</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler, </span><span style="color: #0000ff;">typename</span><span style="color: #000000;">... Args&gt;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> makeHandlerImpl(</span><span style="color: #0000ff;">void</span><span style="color: #000000;">(Processor::*)(Args...)) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Handler{</span></div><div><span style="color: #000000;">&#160; &#160; &#160; [](Processor &amp;processor, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json &amp;request) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> </span><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">...(Args) == </span><span style="color: #098658;">0</span><span style="color: #000000;">) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; (processor.*handler)();</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!validateArgs&lt;Args...&gt;(request))</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request arguments are invalid"</span><span style="color: #000000;"> };</span></div><br><div><span style="color: #000000;">&#160; &#160; &#160; &#160; &#160; apply(processor, handler, request);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; };</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;">(*handlerImpl)(Processor&amp;, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json&amp;) = </span><span style="color: #0000ff;">nullptr</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">};</span></div><br><br><div><span style="color: #0000ff;">struct</span><span style="color: #000000;"> Processor {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> foo() {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'foo' request\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> bar(Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::string_view&gt; s) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'bar' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; s.value &lt;&lt; </span><span style="color: #a31515;">"'\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> baz(Param&lt;</span><span style="color: #a31515;">"count"</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;">&gt; i, Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::string_view&gt; s, Param&lt;</span><span style="color: #a31515;">"payload"</span><span style="color: #000000;">, json&gt; p) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'baz' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; i.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; i.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; s.value &lt;&lt; </span><span style="color: #a31515;">"', and\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; p.name() &lt;&lt; </span><span style="color: #a31515;">"=\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &lt;&lt; p.value.dump() &lt;&lt; </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> qux(Param&lt;</span><span style="color: #a31515;">"count"</span><span style="color: #000000;">, </span><span style="color: #0000ff;">int</span><span style="color: #000000;">&gt; i, Param&lt;</span><span style="color: #a31515;">"id"</span><span style="color: #000000;">, std::optional&lt;std::string_view&gt;&gt; s, Param&lt;</span><span style="color: #a31515;">"payload"</span><span style="color: #000000;">, json&gt; p) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"got 'qux' request with\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #a31515;">" "</span><span style="color: #000000;"> &lt;&lt; i.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; i.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (s.value) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">' '</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">"='"</span><span style="color: #000000;"> &lt;&lt; *s.value &lt;&lt; </span><span style="color: #a31515;">"',\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">' '</span><span style="color: #000000;"> &lt;&lt; s.name() &lt;&lt; </span><span style="color: #a31515;">" parameter is absent,\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">" and\n "</span><span style="color: #000000;"> &lt;&lt; p.name() &lt;&lt; </span><span style="color: #a31515;">"=\n"</span></div><div><span style="color: #000000;">&#160; &#160; &#160; &lt;&lt; p.value.dump() &lt;&lt; </span><span style="color: #a31515;">"\n"</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">};</span></div><br><br><div><span style="color: #0000ff;">template</span><span style="color: #000000;">&lt;StringLiteral name, </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler&gt;</span></div><div><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> h() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> std::tuple{ Name{ name.value }, Handler&lt;Processor&gt;::makeHandler&lt;handler&gt;() };</span></div><div><span style="color: #000000;">}</span></div><br><div><span style="color: #0000ff;">constexpr</span><span style="color: #000000;"> std::tuple&lt;Name, Handler&lt;Processor&gt;&gt; handlers[] = {</span></div><div><span style="color: #000000;">&#160; h&lt;</span><span style="color: #a31515;">"foo"</span><span style="color: #000000;">, &amp;Processor::foo&gt;(),</span></div><div><span style="color: #000000;">&#160; h&lt;</span><span style="color: #a31515;">"bar"</span><span style="color: #000000;">, &amp;Processor::bar&gt;(),</span></div><div><span style="color: #000000;">&#160; h&lt;</span><span style="color: #a31515;">"baz"</span><span style="color: #000000;">, &amp;Processor::baz&gt;(),</span></div><div><span style="color: #000000;">&#160; h&lt;</span><span style="color: #a31515;">"qux"</span><span style="color: #000000;">, &amp;Processor::qux&gt;()</span></div><div><span style="color: #000000;">};</span></div><br><div><span style="color: #0000ff;">void</span><span style="color: #000000;"> processRequest(Processor &amp;processor, </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::string_view &amp;message) {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> json = json::parse(message);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (!json.is_object())</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request is not a valid JSON"</span><span style="color: #000000;"> };</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> request = json.find(</span><span style="color: #a31515;">"request"</span><span style="color: #000000;">);</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (request == json.end())</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> std::invalid_argument{ </span><span style="color: #a31515;">"request does not contain name"</span><span style="color: #000000;"> };</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> &amp;name = request-&gt;get_ref&lt;</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> json::string_t&amp;&gt;();</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* trying to process "</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> handler : handlers) {</span></div><div><span style="color: #000000;">&#160; &#160; </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (std::get&lt;Name&gt;(handler) == name) {</span></div><div><span style="color: #000000;">&#160; &#160; &#160; std::get&lt;Handler&lt;Processor&gt;&gt;(handler)(processor, json);</span></div><div><span style="color: #000000;">&#160; &#160; &#160; </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; &#160; }</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"* could not handle request "</span><span style="color: #000000;"> &lt;&lt; name &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">}</span></div><br><br><div><span style="color: #0000ff;">int</span><span style="color: #000000;"> main() {</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">auto</span><span style="color: #000000;"> request = </span><span style="color: #a31515;">R"({</span></div><div><span style="color: #a31515;">&#160; &#160; "request":"qux",</span></div><div><span style="color: #a31515;">&#160; &#160; "count":1,</span></div><div><span style="color: #a31515;">&#160; &#160; "id":"two",</span></div><div><span style="color: #a31515;">&#160; &#160; "payload":{ "three":3 }</span></div><div><span style="color: #a31515;">})"</span><span style="color: #000000;">sv;</span></div><br><div><span style="color: #000000;">&#160; Processor processor{};</span></div><br><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {</span></div><div><span style="color: #000000;">&#160; &#160; processRequest(processor, request);</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">&#160; </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">const</span><span style="color: #000000;"> std::exception &amp;e) {</span></div><div><span style="color: #000000;">&#160; &#160; std::cout &lt;&lt; </span><span style="color: #a31515;">"error: "</span><span style="color: #000000;"> &lt;&lt; e.what() &lt;&lt; </span><span style="color: #a31515;">'\n'</span><span style="color: #000000;">;</span></div><div><span style="color: #000000;">&#160; }</span></div><div><span style="color: #000000;">}</span></div></div>
</details>